<div class="positioned" id="income"></div>
<div class="positioned" id="wealth"></div>
<div class="positioned" id="chat" onclick="hide()">
  <span id="chat_history">

  </span>
  <textarea id="chat_input">

  </textarea>
</div>
<div class="container" onclick="myFunction(this)">
  <div class="bar1"></div>
  <div class="bar2"></div>
  <div class="bar3"></div>
</div>

<script>
  // keyboard events
  keys = {}
  window.addEventListener("keydown", e => {
    keys[e.key] = true

    if(e.key == "t") {
      // Focus and open chat
      document.getElementById("chat").classList.remove("hidden")
      document.getElementById("chat_input").focus()
    }
  })
  window.addEventListener("keyup", e => {
    keys[e.key] = false
  })
  const chat_input = document.getElementById("chat_input")
  chat_input.addEventListener("keydown", (e) => {
    if(e.which === 13 && !e.ctrlKey) {
      if(!e.repeat) {
        const text = chat_input.value.trim()
        chat_input.value = ""
        if(text) {
          send({
            game_event: true,
            type: "playerMessage",
            text
          })
        }
      }
      e.preventDefault()
    }
  })

  const deltaTime = 0.2;
  const speed = 5;
  setInterval(() => {
    const playerMe = me()

    v_x = (keys["a"] ? -1 : 0) + (keys["d"] ? 1 : 0)
    v_y = (keys["s"] ? -1 : 0) + (keys["w"] ? 1 : 0)
    norm = Math.sqrt(v_x * v_x + v_y * v_y)
    let velocity = speed * deltaTime
    if(norm != 0){
      velocity /= norm
      send({
          game_event: true,
          type: "playerMove",
          x: playerMe.x += v_x * velocity,
          y: playerMe.y += v_y * velocity
        })
    }
    elapsed = 0
  }, deltaTime * 1000 + 5); // add a correction to prevent faulty anti-cheat triggers


  function myFunction(x) {
    x.classList.toggle("change");
  }

  function hide() {
    document.getElementById('chat').classList.add('hidden')
  }


  // ATLAS DATA

  const atlasData = {
    frames: {
      soil: {
          frame: { x: 0, y:0, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 0, y:0, w:16, h:16 }
      },
      sandySoilBot: {
          frame: { x: 0, y:16, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 0, y:16, w:16, h:16 }
      },
      sandySoilRight: {
          frame: { x: 0, y:32, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 0, y:32, w:16, h:16 }
      },
      sandySoilLeft: {
          frame: { x: 0, y:48, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 0, y:48, w:16, h:16 }
      },
      hole: {
          frame: { x: 0, y:64, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 0, y:64, w:16, h:16 }
      },
      torch: {
          frame: { x: 0, y:88, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 0, y:88, w:16, h:16 }
      },
      holeTopLeft: {
          frame: { x: 16, y:0, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 16, y:0, w:16, h:16 }
      },
      holeTop: {
          frame: { x: 32, y:0, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 32, y:0, w:16, h:16 }
      },
      holeTopRight: {
          frame: { x: 48, y:0, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 48, y:0, w:16, h:16 }
      },
      holeLeft: {
          frame: { x: 16, y:16, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 16, y:16, w:16, h:16 }
      },
      holeMid: {
          frame: { x: 32, y:16, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 32, y:16, w:16, h:16 }
      },
      holeRight: {
          frame: { x: 48, y:16, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 48, y:16, w:16, h:16 }
      },
      holeBotLeft: {
          frame: { x: 16, y:32, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 16, y:32, w:16, h:16 }
      },
      holeBot: {
          frame: { x: 32, y:32, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 32, y:32, w:16, h:16 }
      },
      holeBotRight: {
          frame: { x: 48, y:32, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 48, y:32, w:16, h:16 }
      },
      lakeTopLeft: {
          frame: { x: 0, y:128, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 0, y:128, w:16, h:16 }
      },
      lakeTop: {
          frame: { x: 16, y:128, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 16, y:128, w:16, h:16 }
      },
      lakeTopRight: {
          frame: { x: 32, y:128, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 32, y:128, w:16, h:16 }
      },
      lakeLeft: {
          frame: { x: 0, y:144, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 0, y:144, w:16, h:16 }
      },
      lakeMid: {
          frame: { x: 16, y:144, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 16, y:144, w:16, h:16 }
      },
      lakeRight: {
          frame: { x: 32, y:144, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 32, y:144, w:16, h:16 }
      },
      lakeBotLeft: {
          frame: { x: 0, y:160, w:16, h:16 },
          sourceSize: { h:16, w:16},
          spriteSourceSize: { x: 0, y:160, w:16, h:16 }
      },
      
      meta: {
          image: 'textures/cave.png',
      format: 'RGBA8888',
      size: { w: 256, h: 160 },
      scale: 1
      }
    },

    frames: {
      grass: {
        frame: { x: 0, y:0, w:16, h:16 },
        sourceSize: { h:16, w:16},
        spriteSourceSize: { x: 0, y:0, w:16, h:16 }
      },
      meta: {
        image: 'textures/Overworld.png',
        format: 'RGBA8888',
        size: { w: 640, h: 256 },
        scale: 1
      }
    }
  }

  // PixiJS code
  let app = new PIXI.Application({
    width: window.innerWidth,
    height: window.innerHeight,
  });
  document.getElementById("page").appendChild(app.view);
  window.addEventListener("resize", function () {
    app.renderer.resize(window.innerWidth, window.innerHeight);
  });

</script>

<style>
  * {
    color: white;
  }

  #chat_history {
    overflow-y: scroll;
    white-space: pre-line;
    height: 90%;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  #chat_input {
    margin: 10px;
    padding: 0;
    background: none;
    border: 2px rgba(0, 0, 0, 0.5) solid;
    border-radius: 4px;
    resize: none;
  }

  #chat_history::-webkit-scrollbar { 
      display: none;
  }

  .hidden {
    display: none;
  }

  .container {
    display: inline-block;
    cursor: pointer;
    position: absolute;
    bottom: 5px;
    right: 5px;
  }

  .bar1,
  .bar2,
  .bar3 {
    width: 35px;
    height: 5px;
    background-color: #333;
    margin: 6px 0;
    transition: 0.4s;
  }

  .change .bar1 {
    transform: translate(0, 11px) rotate(-45deg);
  }

  .change .bar2 {
    opacity: 0;
  }

  .change .bar3 {
    transform: translate(0, -11px) rotate(45deg);
  }

  .positioned {
    position: absolute;
    border: 3px solid black;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 5px;
  }

  #income {
    top: 5px;
    left: 5px;
    width: 300px;
    height: 150px;
  }
  #wealth {
    top: 5px;
    right: 5px;
    width: 150px;
    height: 200px;
  }
  #chat {
    display: flex;
    flex-direction: column;
    bottom: 5px;
    left: 5px;
    width: 350px;
    height: 400px;
  }
</style>
